---
title: "Autocerrelaci√≥n espacial"

author:
  - name: Manuel Sp√≠nola
    url: http://www.icomvis.una.ac.cr/index.php/manuel
    affiliation: ICOMVIS - UNA
    affiliation-url: http://www.icomvis.una.ac.cr/
    orcid: 0000-0002-7839-1908

format:
  html:
    embed-resources: true

date: "2025-06-09"

toc: true
toc-title: Tabla de contenido
toc-location: right
toc-depth: 4
execute: 
  echo: false
  include: false
citation: true

bibliography: 
  - references.bib
  - grateful-refs.bib

lang: es

title-block-banner: "#f0f3f5"
title-block-banner-color: "#0041C2"
---

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(easystats)
library(sf)
library(sfdep)
library(patchwork)
library(gt)
library(gtExtras)
library(tibble)
library(grateful)
library(crgeo)
```

# üìç Introducci√≥n: Explorando la Autocorrelaci√≥n Espacial

-   Cuando se analizan fen√≥menos geogr√°ficos ‚Äîcomo la distribuci√≥n de la pobreza, la incidencia de enfermedades o la calidad ambiental‚Äî es com√∫n preguntarse si los valores observados en una regi√≥n est√°n relacionados con los de sus regiones vecinas. Esta dependencia espacial se conoce como autocorrelaci√≥n espacial @fig-esquema-autocorrelacion.

```{r}
#| include: true
#| out-width: 100%
#| label: fig-esquema-autocorrelacion
#| fig.cap: "Ejemplos conceptuales de autocorrelaci√≥n espacial. La autocorrelaci√≥n positiva se observa cuando los valores similares (altos o bajos) est√°n agrupados espacialmente. La autocorrelaci√≥n negativa ocurre cuando valores dis√≠miles est√°n pr√≥ximos entre s√≠, generando un patr√≥n alternante. En ausencia de autocorrelaci√≥n, los valores se distribuyen de forma aleatoria en el espacio, sin patrones evidentes."

# Crear una grilla simple con valores para cada patr√≥n
make_grid <- function(vals) {
  expand.grid(x = 1:4, y = 4:1) %>%
    mutate(value = vals)
}

grid_pos <- make_grid(c(10,10,9,9,10,10,9,9,2,2,3,3,2,2,3,3))
grid_neg <- make_grid(c(10,2,10,2,2,10,2,10,10,2,10,2,2,10,2,10))
grid_rand <- make_grid(sample(1:10, 16, replace = TRUE))

plot_pattern <- function(grid, title) {
  ggplot(grid, aes(x, y, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_viridis_c(option = "C") +
    coord_fixed() +
    labs(title = title) +
    theme_void() +
    theme(legend.position = "none")
}

library(patchwork)
plot_pattern(grid_pos, "  Autocorrelaci√≥n positiva") +
plot_pattern(grid_neg, "  Autocorrelaci√≥n negativa") +
plot_pattern(grid_rand, "  Sin autocorrelaci√≥n")
```

-   A diferencia de los an√°lisis estad√≠sticos tradicionales que asumen independencia entre observaciones, la autocorrelaci√≥n espacial permite detectar agrupamientos o patrones geogr√°ficos. Para este prop√≥sito, se utilizan herramientas como los **Indicadores Locales de Asociaci√≥n Espacial (LISA)**, que ayudan a identificar √°reas donde existen agrupamientos estad√≠sticamente significativos de valores altos o bajos.

-   Uno de los LISA m√°s utilizados es el **estad√≠stico I de Moran local (√çndice de Moran)**, que permite cuantificar la autocorrelaci√≥n espacial para cada unidad geogr√°fica por separado. Este indicador clasifica los resultados en patrones como High-High (zonas con valores altos rodeadas de otras zonas altas), Low-Low, High-Low, Low-High, y sin asociaci√≥n significativa, permitiendo interpretar el comportamiento espacial de un fen√≥meno con mayor detalle.

-   En este art√≠culo, aplico el estad√≠stico I de Moran local para analizar la distribuci√≥n espacial el √çndice de Pobreza Multidimensional a nivel cantonal en Costa Rica, que podr√≠a tener el objetivo de identificar patrones territoriales que puedan guiar decisiones informadas y pol√≠ticas p√∫blicas m√°s eficaces.

```{r}
cr <- cr_outline_c |>
  st_transform(crs = 5367) |>
  st_make_valid()
```

```{r}
cr
```

```{r}
c <- st_read("Cantones 84.json", crs = 5367) |>
  st_make_valid()
```

```{r}
c <- st_intersection(c, cr)
```

```{r}
ipm <- data_read("indice_de_pobreza_multidimensional.xlsx", sheet = 4)
```

```{r}
ipm$Cant√≥n
```

```{r}
ipm <- ipm |> separate_wider_delim(Cant√≥n, delim = ": ", names = c("id", "canton")) |>
  arrange(canton)
```

```{r}
ipm$canton
```

```{r}
c <- c |> rename(canton = CANT√ìN) |>
  arrange(canton)
```

```{r}
c$canton
```

```{r}
c <- left_join(c, ipm, by = "canton")
```

```{r}
c
```

```{r}
c <- c |>
  select(canton, IPM, geometry)
```

```{r}
#| include: true
#| out-width: 100%
#| label: fig-ipm
#| fig.cap: "Mapa del √çndice de Pobreza Multidimensional (IPM) en los cantones de Costa Rica para el a√±o 2023"
ggplot() +
  geom_sf(data = c, aes(fill = IPM)) +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(title = "√çndice de Pobreza Multidimensional por Cant√≥n en Costa Rica (2023)", 
       fill = "IPM",
       caption = "Fuente: PNUD (2023), √çndice de pobreza multidimensional cantonal de Costa Rica.")
```

```{r}
geo <- st_geometry(c)
```

```{r}
nb <- st_contiguity(geo)
```

```{r}
wt <- st_weights(nb)
```

```{r}
st_nb_lag(nb, 2)
```

```{r}
st_nb_lag_cumul(nb, 2)
```

```{r}
c$IPM
```

```{r}
h <- c %>%
  mutate(nb = nb, wt = wt)
```

```{r}
h
```

```{r}
h |>
  mutate(weighted_mean_lag = st_lag(c$IPM, nb, wt)) %>% 
  ggplot(aes(fill = weighted_mean_lag)) + 
  geom_sf(lwd = 0.2, color = "black") +
  theme_void()
```

```{r}
lisa <- h |>
  mutate(moran = local_moran(IPM, nb, wt))
```

```{r}
lisa$moran
```

```{r}
pull(lisa, moran)
```

## An√°lisis de Autocorrelaci√≥n Espacial seg√∫n el √çndie de Moran

-   En un an√°lisis LISA (Local Indicators of Spatial Association) con el √çndice de Moran, las categor√≠as: High-High, Low-Low, High-Low y Low-High indican el tipo de agrupamiento espacial (cl√∫sters espaciales) entre los valores de la variable y los valores de las √°reas vecinas. Aqu√≠ te explico qu√© significa cada uno:

üî¥ High-High (Alto-Alto)

-   Una zona tiene un valor alto de la variable (por ejemplo, pobreza, criminalidad, etc.).

-   Y est√° rodeada de otras zonas que tambi√©n tienen valores altos.

-   üëâ Es un cluster significativo de valores altos.

------------------------------------------------------------------------

üîµ Low-Low (Bajo-Bajo)

-   Una zona tiene un valor bajo, y est√° rodeada de zonas con valores bajos.

-   üëâ Es un cluster significativo de valores bajos.

------------------------------------------------------------------------

üü° High-Low (Alto-Bajo)

-   Una zona con valor alto, rodeada de zonas con valores bajos.

-   üëâ Se interpreta como un outlier espacial o una zona at√≠pica.

------------------------------------------------------------------------

üü¢ Low-High (Bajo-Alto)

-   Una zona con valor bajo, rodeada de zonas con valores altos.

-   üëâ Tambi√©n es un outlier espacial.

------------------------------------------------------------------------

‚ö™ No significativo

-   No hay evidencia estad√≠sticamente significativa de asociaci√≥n espacial.

-   La zona no pertenece a ning√∫n cluster detectado.

```{r}
#| include: true
#| label: tbl-descripcion-lisa
#| tbl-cap: "Descripci√≥n de los Cl√∫steres Espaciales seg√∫n el √çndice de Moran local"
tibble(
  Cluster = c(
    "üî¥ High-High", 
    "üîµ Low-Low", 
    "üü° High-Low", 
    "üü¢ Low-High", 
    "‚ö™ No significativo"
  ),
  Significado = c(
    "Zona con valores altos rodeada de otras zonas con valores altos (cl√∫ster positivo)",
    "Zona con valores bajos rodeada de otras zonas con valores bajos (cl√∫ster positivo)",
    "Zona con valores altos rodeada de zonas con valores bajos (outlier)",
    "Zona con valores bajos rodeada de zonas con valores altos (outlier)",
    "No se detecta un patr√≥n espacial significativo"
  )
) |>
  gt() |>
  cols_label(
    Cluster = "Categor√≠a",
    Significado = "Significado"
  ) |>
  fmt_markdown(columns = everything())
```

```{r}
lisa_colors <- c(
  "High-High" = "red2",   # rojo fuerte
  "Low-Low" = "blue3",     # azul fuerte
  "High-Low" = "yellow2",    # naranja
  "Low-High" = "green3",    # violeta
  "No significativo" = "grey90"  # gris claro
)
```

```{r}
#| include: true
#| out-width: 100%
#| label: fig-lisa
#| fig.cap: "Mapa de autocorrelaci√≥n espacial del √çndice de Pobreza Multidimensional (IPM) por Cant√≥n en Costa Rica seg√∫n el √çndice de Mor√°n local."
lisa |> 
  tidyr::unnest(moran) |> 
  ggplot(aes(fill = pysal)) +
  geom_sf() +
  geom_sf(lwd = 0.2, color = "white") +
  theme_minimal() +
  scale_fill_manual(values = lisa_colors, na.translate = FALSE) +
  labs(fill = "Autocorrelaci√≥n\nLocal (LISA)",
       title = "Mapa de Cl√∫steres Espaciales seg√∫n el I de Moran Local")
```

-   High-high and low-low = spatial clusters

-   High-low and low-high = spatial outliers

## Cl√∫steres espaciales estad√≠sticamente significativos (p \< 0.05) seg√∫n el √çndice de Moran

```{r}
lisa_unnested <- lisa |> unnest(moran)
```

```{r}
lisa_unnested <- lisa_unnested |>
  mutate(
    cluster_sig = ifelse(p_ii_sim < 0.05, as.character(pysal), "No Significativo")
  )
```

```{r}
#| include: true
#| out-width: 100%
#| label: fig-lisa-clusters
#| fig.cap: "Mapa de Cl√∫steres del √çndice de Pobreza Multidimensional (IPM) por Cant√≥n en Costa Rica seg√∫n el √çndice de Moran local."

ggplot(lisa_unnested) +
  geom_sf(aes(fill = cluster_sig)) +
  scale_fill_manual(values = c(
    "High-High" = "red2",
    "Low-Low" = "blue3",
    "High-Low" = "yellow2",
    "Low-High" = "green3",
    "No Significativo" = "grey90"
  )) +
  theme_minimal() +
  labs(
    fill = "Tipo de Cluster \nEspacial"
  )
```

```{r}
#| include: true
#| out-width: 100%
#| label: tbl-lisa-ipm 
#| tbl-cap: "Interpretaci√≥n de cl√∫steres espaciales seg√∫n el √çndice de Moran local para los valores de √çndice de Pobreza Multidimensional (IPM) en cantones de Costa Rica."
# Crear la tabla de significado
tabla_lisa <- tribble(
  ~Cluster,      ~Significado,
  "üî¥ High-High",   "Zonas muy pobres rodeadas de otras zonas pobres",
  "üîµ Low-Low",     "Zonas poco pobres rodeadas de otras zonas poco pobres",
  "üü° High-Low",    "Zonas pobres rodeadas de zonas no pobres (outlier)",
  "üü¢ Low-High",    "Zonas no pobres rodeadas de zonas pobres (outlier)",
  "‚ö™ No significativo",          "Sin patr√≥n espacial claro"
)

# Mostrar como tabla gt
tabla_lisa |> 
  gt() |>
  cols_label(
    Cluster = "Cl√∫ster",
    Significado = "Interpretaci√≥n"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(everything())
  )
```

-   Los cl√∫steres espaciales identificados por el √çndice de Moran local revelan patrones significativos en la distribuci√≥n del √çndice de Pobreza Multidimensional (IPM) en Costa Rica. Las zonas con valores altos de IPM tienden a agruparse en la regi√≥n Norte y Sureste del pa√≠s, lo que sugiere que la pobreza multidimensional no es un fen√≥meno aislado, sino que se manifiesta en √°reas espec√≠ficas del pa√≠s. Por otro lado, las zonas con valores bajos tambi√©n forman un cl√∫ster en la regi√≥n del Valle Central, indicando que hay regiones donde la pobreza multidimensional es menos prevalente.

-   Para los gr√°ficos y an√°lisis us√© R version 4.5.0 [@base] y los siguientes paquetes de R: tidyverse v. 2.0.0 [@tidyverse], sfdep v. 0.2.5 [@sfdep], easystats v. 0.7.0 [@easystats], gt v. 0.8.2 [@gt] y sf v 1.0.21 [@sf2018]. Los datos del √çndice de Pobreza Multidimensional fueron obtenidos del Programa de las Naciones Unidas para el Desarrollo (PNUD) [@pnud2023ipm].

```{r}
cite_packages(output = "paragraph", out.dir = ".")
```
